<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GLOW — Chat (Bootstrap + htmx)</title>
  <!-- Bootstrap CSS (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Bootstrap Icons (optional) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <!-- htmx (CDN) -->
  <script src="https://unpkg.com/htmx.org@1.9.12" defer></script>

  <style>
    :root{
      --bg:#050714;
      --panel:#0b1024;
      --panel2:#0a0f22;
      --text:#e9ecff;
      --muted:#a9b7ff;
      --accent:#7aa2ff;
      --success:#50e3a4;
      --glow1:#6ea8fe;
      --glow2:#cb7bff;
      --glow3:#66ffe3;
      --card-shadow: 0 12px 40px rgba(0,0,0,.35);
    }

    /* Background nebula + subtle grid */
    html,body{height:100%; background:
      radial-gradient(1200px 800px at 10% -10%, rgba(120,140,255,.18), transparent 60%),
      radial-gradient(900px 600px at 120% 10%, rgba(203,123,255,.15), transparent 60%),
      linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.0)),
      var(--bg); color:var(--text);}

    .glass-card{background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); border:1px solid rgba(255,255,255,.08);
                backdrop-filter: blur(10px); border-radius:24px; box-shadow: var(--card-shadow); position:relative;}

    /* Neon border glow */
    .glass-card:before{content:""; position:absolute; inset:-1px; border-radius:24px; padding:1px; background:
      linear-gradient(135deg, var(--glow1), transparent 35%, var(--glow2), transparent 70%, var(--glow3));
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor; mask-composite: exclude; filter: blur(10px); opacity:.35;}

    /* Brand glow */
    .brand{
      letter-spacing:.6px;
      text-shadow: 0 0 18px rgba(110,168,254,.8), 0 0 30px rgba(203,123,255,.5);
    }
    .gradient-text{background: linear-gradient(90deg, var(--glow1), var(--glow2), var(--glow3)); -webkit-background-clip:text; background-clip:text; color:transparent}

    .dot{width:10px; height:10px; border-radius:999px; display:inline-block}
    .dot.online{background:var(--success); box-shadow:0 0 12px var(--success);}
    .dot.offline{background:#6c757d}

    .scroll-y{overflow-y:auto}

    /* Message bubbles with glow */
    .msg{padding:.65rem .85rem; border-radius:14px; max-width: 80%; box-shadow: 0 6px 18px rgba(0,0,0,.25);}    
    .msg.me{background: rgba(110,168,254,.14); border:1px solid rgba(110,168,254,.35); box-shadow:0 0 24px rgba(110,168,254,.25);}   
    .msg.other{background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12);}   
    .msg small{color:var(--muted)}

    .room-pill{cursor:pointer; user-select:none}
    .room-pill.active{background: rgba(110,168,254,.25); border-color: rgba(110,168,254,.55)}

    /* Panels */
    .panel{background:var(--panel); border:1px solid rgba(255,255,255,.08); border-radius:24px}

    /* Animate subtle glow on header icon */
    @keyframes pulseGlow{ 0%{ filter: drop-shadow(0 0 0 rgba(110,168,254,.0)); } 50%{ filter: drop-shadow(0 0 12px rgba(110,168,254,.7)); } 100%{ filter: drop-shadow(0 0 0 rgba(110,168,254,.0)); } }
    .icon-glow{ animation: pulseGlow 3s ease-in-out infinite; }
      /* Improve text wrapping */
    .msg-text{white-space:pre-wrap; word-wrap:break-word}
  </style>
</head>
<body>

<div class="container my-4">
  <div class="glass-card p-3 p-md-4">
    <!-- Header / Controls -->
    <div class="d-flex align-items-center justify-content-between gap-3 pb-3 border-bottom border-1 border-light-subtle">
      <div class="d-flex align-items-center gap-3">
        <div class="rounded-circle d-flex align-items-center justify-content-center icon-glow" style="width:46px;height:46px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12)">
          <i class="bi bi-lightning-charge-fill fs-5"></i>
        </div>
        <div>
          <div class="fw-semibold brand">GLOW <span class="gradient-text">Chat</span></div>
          <div class="small text-secondary">Bootstrap + htmx • WebSocket Rooms</div>
        </div>
      </div>
      <div class="d-flex align-items-center gap-2 flex-wrap">
        <span class="badge text-bg-dark border border-secondary-subtle" id="statusBadge"><span class="dot offline me-1"></span>Disconnected</span>
        <button class="btn btn-sm btn-outline-light" data-bs-toggle="modal" data-bs-target="#channelsModal"><i class="bi bi-hash me-1"></i>Channels</button>
        <button class="btn btn-sm btn-primary" data-bs-toggle="offcanvas" data-bs-target="#settingsPane"><i class="bi bi-gear me-1"></i>Settings</button>
      </div>
    </div>

    <!-- Main Split -->
    <div class="row g-3 pt-3">
      <!-- Rooms Sidebar -->
      <div class="col-12 col-md-3">
        <div class="p-3 panel">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="fw-semibold">Rooms</div>
            <button class="btn btn-sm btn-outline-light" id="btnRefreshRooms" title="Refresh rooms"><i class="bi bi-arrow-repeat"></i></button>
          </div>
          <div id="roomList" class="d-flex flex-wrap gap-2"></div>
          <div class="input-group input-group-sm mt-3">
            <input type="text" class="form-control" placeholder="Create / join room…" id="roomInput" />
            <button class="btn btn-outline-light" id="btnJoinRoom">Join</button>
          </div>
        </div>
      </div>

      <!-- Chat Column -->
      <div class="col-12 col-md-9">
        <div class="p-3 panel d-flex flex-column" style="height:65vh; background:linear-gradient(180deg,var(--panel), var(--panel2));">
          <div class="d-flex align-items-center justify-content-between pb-2 border-bottom border-1 border-light-subtle">
            <div>
              <div class="fw-semibold">#<span id="currentRoom">general</span></div>
              <div class="small text-secondary">Connected as <span id="currentUser">guest</span></div>
            </div>
            <div class="text-end small">
              <span class="text-secondary">Base URL:</span> <span id="lblBaseUrl">—</span>
            </div>
          </div>

          <div id="messages" class="flex-grow-1 scroll-y py-2 pe-1"></div>

          <form id="sendForm" class="mt-2">
            <div class="input-group">
              <input id="msgInput" type="text" class="form-control" placeholder="Type a message… (enter to send)" autocomplete="off" />
              <button class="btn btn-primary" type="submit"><i class="bi bi-send"></i><span class="d-none d-md-inline ms-2">Send</span></button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Settings / Auth Offcanvas -->
<div class="offcanvas offcanvas-end text-bg-dark" tabindex="-1" id="settingsPane">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">Settings & Auth</h5>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body small">
    <form id="authForm" class="d-grid gap-3">
      <div>
        <label class="form-label">Base URL</label>
        <input class="form-control" id="baseUrl" placeholder="http://127.0.0.1:3000" />
        <div class="form-text">Your API base (must allow CORS)</div>
      </div>
      <div class="row g-2">
        <div class="col-6">
          <label class="form-label">Username</label>
          <input class="form-control" id="username" />
        </div>
        <div class="col-6">
          <label class="form-label">Password</label>
          <input type="password" class="form-control" id="password" />
        </div>
      </div>
      <div>
        <label class="form-label">Default Room</label>
        <input class="form-control" id="defaultRoom" placeholder="general" />
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-primary flex-grow-1" id="btnLogin" type="button"><i class="bi bi-door-open me-1"></i>Login / Register</button>
        <button class="btn btn-outline-light" id="btnLogout" type="button"><i class="bi bi-box-arrow-right me-1"></i>Logout</button>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="autoReconnect" checked>
        <label class="form-check-label" for="autoReconnect">Auto-reconnect</label>
      </div>
      <div class="alert alert-warning mt-2" role="alert">
        <strong>Browser caveat:</strong> You can't set custom <code>Authorization</code> headers for WebSockets in browsers. This UI appends <code>?token=…</code> to the WS URL. Ensure your server accepts that.
      </div>
    </form>
  </div>
</div>

<!-- Channels Modal -->
<div class="modal fade" id="channelsModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content text-bg-dark border border-secondary">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-hash me-2"></i>Channels</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="channelsList" class="d-flex flex-wrap gap-2"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Templates -->
<template id="msg-template">
  <div class="d-flex my-1">
    <div class="msg other">
      <div class="msg-user fw-semibold small"></div>
      <div class="msg-text"></div>
      <small class="msg-time text-secondary"></small>
    </div>
  </div>
</template>
<template id="msg-me-template">
  <div class="d-flex my-1 justify-content-end">
    <div class="msg me">
      <div class="msg-user fw-semibold small"></div>
      <div class="msg-text"></div>
      <small class="msg-time text-secondary"></small>
    </div>
  </div>
</template>

<!-- Bootstrap Bundle (JS) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
// --- Minimal state management ---
const state = {
  baseUrl:  localStorage.getItem('chat.baseUrl') || 'http://127.0.0.1:3000',
  username: localStorage.getItem('chat.username') || `web${Date.now().toString().slice(-6)}`,
  password: localStorage.getItem('chat.password') || 'secret123',
  token:    localStorage.getItem('chat.token') || '',
  room:     localStorage.getItem('chat.room') || 'general',
  autoReconnect: (localStorage.getItem('chat.autoReconnect') !== 'false'),
  ws: null,
  reconnectTimer: null,
  connecting: false,
  seen: new Set(), // de-dup guard for incoming msgs
};

// --- Elements ---
const $ = (s)=>document.querySelector(s);
const statusBadge = $('#statusBadge');
const lblBaseUrl  = $('#lblBaseUrl');
const currentRoom = $('#currentRoom');
const currentUser = $('#currentUser');
const messages    = $('#messages');
const roomList    = $('#roomList');
const channelsList= $('#channelsList');

// Settings form
const baseUrlEl = $('#baseUrl');
const usernameEl= $('#username');
const passwordEl= $('#password');
const defaultRoomEl=$('#defaultRoom');
const autoReconnectEl=$('#autoReconnect');

// Init form values
function syncFormFromState(){
  baseUrlEl.value = state.baseUrl;
  usernameEl.value = state.username;
  passwordEl.value = state.password;
  defaultRoomEl.value = state.room;
  autoReconnectEl.checked = state.autoReconnect;
  lblBaseUrl.textContent = state.baseUrl;
  currentRoom.textContent = state.room;
  currentUser.textContent = state.username;
}

function persist(k,v){
  state[k]=v;
  localStorage.setItem('chat.'+k, String(v));
}

function setStatus(on){
  statusBadge.innerHTML = (on)
    ? '<span class="dot online me-1"></span>Connected'
    : '<span class="dot offline me-1"></span>Disconnected';
}

function toast(msg, type='info'){
  // Simple inline toast
  const el = document.createElement('div');
  el.className = `position-fixed top-0 start-50 translate-middle-x mt-3 alert alert-${type}`;
  el.style.zIndex = 1080;
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(()=> el.remove(), 2500);
}

function renderRooms(list){
  roomList.innerHTML = '';
  const unique = new Set([state.room, 'general', ...(list||[])]);
  [...unique].filter(Boolean).forEach(ch=>{
    const pill = document.createElement('span');
    pill.className = 'badge rounded-pill text-bg-dark border border-secondary-subtle room-pill';
    pill.textContent = `#${ch}`;
    if(ch===state.room) pill.classList.add('active');
    pill.onclick = ()=> joinRoom(ch);
    roomList.appendChild(pill);
  });
}

function addMessage({username, text, room, id, ts}){
  // normalize & de-dup  toast('Logged out','secondary');
}

async function fetchChannels(){
  try{ const data = await api('/api/channels');
    const channels = data.channels || [];
    channelsList.innerHTML = '';
    channels.forEach(ch=>{
      const a = document.createElement('span');
      a.className = 'badge text-bg-secondary room-pill';
      a.textContent = '#'+ch;
      a.onclick = ()=>{ joinRoom(ch); const m = bootstrap.Modal.getOrCreateInstance('#channelsModal'); m.hide(); };
      channelsList.appendChild(a);
    });
    renderRooms(channels);
  }catch(e){ toast('Could not load channels','danger'); }
}

function joinRoom(room){
  persist('room', room);
  currentRoom.textContent = room;
  connect(true); // force new connection
}

function connect(force=false){
  if(!state.token){ setStatus(false); return; }
  if(!force && state.ws && (state.ws.readyState===WebSocket.OPEN || state.ws.readyState===WebSocket.CONNECTING)){
    return; // already connected/connecting
  }
  if(state.ws){ try{ state.ws.close(); }catch{} }
  if(state.connecting) return;
  state.connecting = true;

  const wsUrl = new URL(state.baseUrl.replace(/^http/, 'ws'));
  wsUrl.pathname = `/ws/${state.room}`;
  wsUrl.searchParams.set('token', state.token);

  const ws = new WebSocket(wsUrl);
  state.ws = ws;

  ws.onopen = ()=>{ setStatus(true); state.connecting=false; };
  ws.onclose = ()=>{
    setStatus(false);
    state.connecting=false;
    if(state.autoReconnect){ clearTimeout(state.reconnectTimer); state.reconnectTimer = setTimeout(()=>connect(false), 1200); }
  };
  ws.onerror = ()=>{ /* ignore */ };
  ws.onmessage = (ev)=>{
  try{
    const raw = ev.data;
    let data = null;
    try{ data = JSON.parse(raw); }catch{ data = raw; }

    if(Array.isArray(data)){
      data.forEach(m=>{
        if(!m) return;
        const text = m.text ?? m.message ?? m.msg ?? '';
        const user = m.username ?? m.user ?? '';
        const ts   = m.ts ?? m.time ?? m.timestamp;
        if(text) addMessage({username:user, text, room: state.room, id:m.id, ts});
      });
    } else if(typeof data === 'object' && data){
      const text = data.text ?? data.message ?? data.msg ?? '';
      const user = data.username ?? data.user ?? '';
      const ts   = data.ts ?? data.time ?? data.timestamp;
      if(text) addMessage({username:user, text, room: state.room, id:data.id, ts});
    } else if(typeof data === 'string'){
      addMessage({username:'', text:data, room: state.room});
    }
  } catch{ /* ignore */ }
};
}

// --- Wire UI ---
$('#btnLogin').addEventListener('click', loginOrRegister);
$('#btnLogout').addEventListener('click', logout);
$('#btnRefreshRooms').addEventListener('click', fetchChannels);
$('#btnJoinRoom').addEventListener('click', ()=>{ const v=$('#roomInput').value.trim(); if(v) joinRoom(v); });

$('#sendForm').addEventListener('submit', (e)=>{
  e.preventDefault();
  const text = $('#msgInput').value.trim();
  if(!text || !state.ws || state.ws.readyState!==WebSocket.OPEN) return;
  try{ state.ws.send(text); }catch{}
  // Do NOT echo locally; wait for server broadcast to avoid duplicates
  $('#msgInput').value='';
});

// Settings bindings
baseUrlEl.addEventListener('change', e=>{ persist('baseUrl', e.target.value); lblBaseUrl.textContent = e.target.value; });
usernameEl.addEventListener('change', e=>{ persist('username', e.target.value); currentUser.textContent = e.target.value; });
passwordEl.addEventListener('change', e=>{ persist('password', e.target.value); });
defaultRoomEl.addEventListener('change', e=>{ persist('room', e.target.value); currentRoom.textContent = e.target.value; });
autoReconnectEl.addEventListener('change', e=>{ persist('autoReconnect', e.target.checked); });

// htmx: add Authorization automatically
document.addEventListener('htmx:configRequest', (evt)=>{
  if(state.token) evt.detail.headers['Authorization'] = 'Bearer '+state.token;
});

// Init
(function init(){
  syncFormFromState();
  renderRooms([]);
  if(state.token) connect();
})();
</script>
</body>
</html>

